/* Exemple d'illustration des primitives Unix : Un père et ses fils */
/* Fichiers : lecture partagée entre père et fils avec ouverture unique */

#include <stdio.h>    /* entrées sorties */
#include <unistd.h>   /* pimitives de base : fork, ...*/
#include <stdlib.h>   /* exit */
#include <sys/wait.h> /* wait */
#include <string.h>   /* opérations sur les chaines */
#include <fcntl.h>    /* opérations sur les fichiers */

void traitement_erreur(int primitive) {
  if (primitive < 0) {
    perror("Erreur execution\n");
    exit(1);
  }
}

int main()
{
    int fils, retour, desc_fic, ecriture, fils_termine, fermeture;
    int duree_sommeil = 1;

    char fichier[] = "temp.txt";

    /* ouverture du fichier en écriture */
    desc_fic = open(fichier, O_WRONLY | O_CREAT | O_TRUNC, 0640);
    /* traiter systématiquement les retours d'erreur des appels */
    traitement_erreur(desc_fic);


    retour = fork();
    /* traiter systématiquement les retours d'erreur des appels */
    traitement_erreur(retour);


    /* fils */
    if (retour == 0) {
        /* lire le fichier par blocs de 4 octets */
        for (int ifor = 1; ifor <= 10; ifor++) {
            ecriture = dprintf(desc_fic, "FILS\n");
            /* traiter systématiquement les retours d'erreur des appels */
            traitement_erreur(ecriture);
            sleep(duree_sommeil);
        }
            /* Important : terminer un processus par exit */
        exit(EXIT_SUCCESS);   /* Terminaison normale (0 = sans erreur) */
    }

        /* pere */
    else {
      for (int ifor = 1; ifor <= 10; ifor++) {
        ecriture = dprintf(desc_fic, "PERE\n");
        /* traiter systématiquement les retours d'erreur des appels */
        traitement_erreur(ecriture);
        sleep(duree_sommeil);
      }
    }

    fermeture = close(desc_fic);
    /* traiter systématiquement les retours d'erreur des appels */
    traitement_erreur(retour);

    printf("Processus Principal termine\n");
    return EXIT_SUCCESS;
}
